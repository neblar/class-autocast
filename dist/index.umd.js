(function(y,v){typeof exports=="object"&&typeof module<"u"?v(exports):typeof define=="function"&&define.amd?define(["exports"],v):(y=typeof globalThis<"u"?globalThis:y||self,v(y["class-autocast"]={}))})(this,function(y){"use strict";var st=(y,v,T)=>{if(!v.has(y))throw TypeError("Cannot "+T)};var S=(y,v,T)=>(st(y,v,"read from private field"),T?T.call(y):v.get(y)),D=(y,v,T)=>{if(v.has(y))throw TypeError("Cannot add the same private member more than once");v instanceof WeakSet?v.add(y):v.set(y,T)};var x,k,_,m;var v=function(){function e(t){this.groups=[],this.each=!1,this.context=void 0,this.type=t.type,this.name=t.name,this.target=t.target,this.propertyName=t.propertyName,this.constraints=t==null?void 0:t.constraints,this.constraintCls=t.constraintCls,this.validationTypeOptions=t.validationTypeOptions,t.validationOptions&&(this.message=t.validationOptions.message,this.groups=t.validationOptions.groups,this.always=t.validationOptions.always,this.each=t.validationOptions.each,this.context=t.validationOptions.context)}return e}(),T=function(){function e(){}return e.prototype.transform=function(t){var n=[];return Object.keys(t.properties).forEach(function(i){t.properties[i].forEach(function(o){var r={message:o.message,groups:o.groups,always:o.always,each:o.each},a={type:o.type,name:o.name,target:t.name,propertyName:i,constraints:o.constraints,validationTypeOptions:o.options,validationOptions:r};n.push(new v(a))})}),n},e}();function q(e){return e instanceof Map?Array.from(e.values()):Array.isArray(e)?e:Array.from(e)}function J(){if(typeof globalThis<"u")return globalThis;if(typeof global<"u")return global;if(typeof window<"u")return window;if(typeof self<"u")return self}function j(e){return e!==null&&typeof e=="object"&&typeof e.then=="function"}var Y=function(e){var t=typeof Symbol=="function"&&Symbol.iterator,n=t&&e[t],i=0;if(n)return n.call(e);if(e&&typeof e.length=="number")return{next:function(){return e&&i>=e.length&&(e=void 0),{value:e&&e[i++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},$=function(e,t){var n=typeof Symbol=="function"&&e[Symbol.iterator];if(!n)return e;var i=n.call(e),o,r=[],a;try{for(;(t===void 0||t-- >0)&&!(o=i.next()).done;)r.push(o.value)}catch(f){a={error:f}}finally{try{o&&!o.done&&(n=i.return)&&n.call(i)}finally{if(a)throw a.error}}return r},K=function(e,t,n){if(n||arguments.length===2)for(var i=0,o=t.length,r;i<o;i++)(r||!(i in t))&&(r||(r=Array.prototype.slice.call(t,0,i)),r[i]=t[i]);return e.concat(r||Array.prototype.slice.call(t))},Q=function(){function e(){this.validationMetadatas=new Map,this.constraintMetadatas=new Map}return Object.defineProperty(e.prototype,"hasValidationMetaData",{get:function(){return!!this.validationMetadatas.size},enumerable:!1,configurable:!0}),e.prototype.addValidationSchema=function(t){var n=this,i=new T().transform(t);i.forEach(function(o){return n.addValidationMetadata(o)})},e.prototype.addValidationMetadata=function(t){var n=this.validationMetadatas.get(t.target);n?n.push(t):this.validationMetadatas.set(t.target,[t])},e.prototype.addConstraintMetadata=function(t){var n=this.constraintMetadatas.get(t.target);n?n.push(t):this.constraintMetadatas.set(t.target,[t])},e.prototype.groupByPropertyName=function(t){var n={};return t.forEach(function(i){n[i.propertyName]||(n[i.propertyName]=[]),n[i.propertyName].push(i)}),n},e.prototype.getTargetValidationMetadatas=function(t,n,i,o,r){var a,f,l=function(u){return typeof u.always<"u"?u.always:u.groups&&u.groups.length?!1:i},s=function(u){return!!(o&&(!r||!r.length)&&u.groups&&u.groups.length)},c=this.validationMetadatas.get(t)||[],p=c.filter(function(u){return u.target!==t&&u.target!==n?!1:l(u)?!0:s(u)?!1:r&&r.length>0?u.groups&&!!u.groups.find(function(h){return r.indexOf(h)!==-1}):!0}),d=[];try{for(var g=Y(this.validationMetadatas.entries()),O=g.next();!O.done;O=g.next()){var V=$(O.value,2),A=V[0],b=V[1];t.prototype instanceof A&&d.push.apply(d,K([],$(b),!1))}}catch(u){a={error:u}}finally{try{O&&!O.done&&(f=g.return)&&f.call(g)}finally{if(a)throw a.error}}var E=d.filter(function(u){return typeof u.target=="string"||u.target===t||u.target instanceof Function&&!(t.prototype instanceof u.target)?!1:l(u)?!0:s(u)?!1:r&&r.length>0?u.groups&&!!u.groups.find(function(h){return r.indexOf(h)!==-1}):!0}),U=E.filter(function(u){return!p.find(function(h){return h.propertyName===u.propertyName&&h.type===u.type})});return p.concat(U)},e.prototype.getTargetValidatorConstraints=function(t){return this.constraintMetadatas.get(t)||[]},e}();function R(){var e=J();return e.classValidatorMetadataStorage||(e.classValidatorMetadataStorage=new Q),e.classValidatorMetadataStorage}var C=function(){function e(){}return e.prototype.toString=function(t,n,i,o){var r=this;t===void 0&&(t=!1),n===void 0&&(n=!1),i===void 0&&(i=""),o===void 0&&(o=!1);var a=t?"\x1B[1m":"",f=t?"\x1B[22m":"",l=function(){var p;return(o?Object.values:Object.keys)((p=r.constraints)!==null&&p!==void 0?p:{}).join(", ")},s=function(p){return" - property ".concat(a).concat(i).concat(p).concat(f," has failed the following constraints: ").concat(a).concat(l()).concat(f,` 
`)};if(n){var c=Number.isInteger(+this.property)?"[".concat(this.property,"]"):"".concat(i?".":"").concat(this.property);return this.constraints?s(c):this.children?this.children.map(function(p){return p.toString(t,!0,"".concat(i).concat(c),o)}).join(""):""}else return"An instance of ".concat(a).concat(this.target?this.target.constructor.name:"an object").concat(f,` has failed the validation:
`)+(this.constraints?s(this.property):"")+(this.children?this.children.map(function(p){return p.toString(t,!0,r.property,o)}).join(""):"")},e}(),w=function(){function e(){}return e.isValid=function(t){var n=this;return t!=="isValid"&&t!=="getMessage"&&Object.keys(this).map(function(i){return n[i]}).indexOf(t)!==-1},e.CUSTOM_VALIDATION="customValidation",e.NESTED_VALIDATION="nestedValidation",e.PROMISE_VALIDATION="promiseValidation",e.CONDITIONAL_VALIDATION="conditionalValidation",e.WHITELIST="whitelistValidation",e.IS_DEFINED="isDefined",e}();function X(e){return Array.isArray(e)?e.join(", "):(typeof e=="symbol"&&(e=e.description),"".concat(e))}var Z=function(){function e(){}return e.replaceMessageSpecialTokens=function(t,n){var i;return t instanceof Function?i=t(n):typeof t=="string"&&(i=t),i&&Array.isArray(n.constraints)&&n.constraints.forEach(function(o,r){i=i.replace(new RegExp("\\$constraint".concat(r+1),"g"),X(o))}),i&&n.value!==void 0&&n.value!==null&&["string","boolean","number"].includes(typeof n.value)&&(i=i.replace(/\$value/g,n.value)),i&&(i=i.replace(/\$property/g,n.property)),i&&(i=i.replace(/\$target/g,n.targetName)),i},e}(),I=function(e,t){var n=typeof Symbol=="function"&&e[Symbol.iterator];if(!n)return e;var i=n.call(e),o,r=[],a;try{for(;(t===void 0||t-- >0)&&!(o=i.next()).done;)r.push(o.value)}catch(f){a={error:f}}finally{try{o&&!o.done&&(n=i.return)&&n.call(i)}finally{if(a)throw a.error}}return r},B=function(){function e(t,n){this.validator=t,this.validatorOptions=n,this.awaitingPromises=[],this.ignoreAsyncValidations=!1,this.metadataStorage=R()}return e.prototype.execute=function(t,n,i){var o=this,r,a;!this.metadataStorage.hasValidationMetaData&&((r=this.validatorOptions)===null||r===void 0?void 0:r.enableDebugMessages)===!0&&console.warn(`No validation metadata found. No validation will be  performed. There are multiple possible reasons:
  - There may be multiple class-validator versions installed. You will need to flatten your dependencies to fix the issue.
  - This validation runs before any file with validation decorator was parsed by NodeJS.`);var f=this.validatorOptions?this.validatorOptions.groups:void 0,l=this.validatorOptions&&this.validatorOptions.strictGroups||!1,s=this.validatorOptions&&this.validatorOptions.always||!1,c=((a=this.validatorOptions)===null||a===void 0?void 0:a.forbidUnknownValues)===void 0||this.validatorOptions.forbidUnknownValues!==!1,p=this.metadataStorage.getTargetValidationMetadatas(t.constructor,n,s,l,f),d=this.metadataStorage.groupByPropertyName(p);if(this.validatorOptions&&c&&!p.length){var g=new C;(!this.validatorOptions||!this.validatorOptions.validationError||this.validatorOptions.validationError.target===void 0||this.validatorOptions.validationError.target===!0)&&(g.target=t),g.value=void 0,g.property=void 0,g.children=[],g.constraints={unknownValue:"an unknown value was passed to the validate function"},i.push(g);return}this.validatorOptions&&this.validatorOptions.whitelist&&this.whitelist(t,d,i),Object.keys(d).forEach(function(O){var V=t[O],A=d[O].filter(function(E){return E.type===w.IS_DEFINED}),b=d[O].filter(function(E){return E.type!==w.IS_DEFINED&&E.type!==w.WHITELIST});V instanceof Promise&&b.find(function(E){return E.type===w.PROMISE_VALIDATION})?o.awaitingPromises.push(V.then(function(E){o.performValidations(t,E,O,A,b,i)})):o.performValidations(t,V,O,A,b,i)})},e.prototype.whitelist=function(t,n,i){var o=this,r=[];Object.keys(t).forEach(function(a){(!n[a]||n[a].length===0)&&r.push(a)}),r.length>0&&(this.validatorOptions&&this.validatorOptions.forbidNonWhitelisted?r.forEach(function(a){var f,l=o.generateValidationError(t,t[a],a);l.constraints=(f={},f[w.WHITELIST]="property ".concat(a," should not exist"),f),l.children=void 0,i.push(l)}):r.forEach(function(a){return delete t[a]}))},e.prototype.stripEmptyErrors=function(t){var n=this;return t.filter(function(i){if(i.children&&(i.children=n.stripEmptyErrors(i.children)),Object.keys(i.constraints).length===0){if(i.children.length===0)return!1;delete i.constraints}return!0})},e.prototype.performValidations=function(t,n,i,o,r,a){var f=r.filter(function(d){return d.type===w.CUSTOM_VALIDATION}),l=r.filter(function(d){return d.type===w.NESTED_VALIDATION}),s=r.filter(function(d){return d.type===w.CONDITIONAL_VALIDATION}),c=this.generateValidationError(t,n,i);a.push(c);var p=this.conditionalValidations(t,n,s);p&&(this.customValidations(t,n,o,c),this.mapContexts(t,n,o,c),!(n===void 0&&this.validatorOptions&&this.validatorOptions.skipUndefinedProperties===!0)&&(n===null&&this.validatorOptions&&this.validatorOptions.skipNullProperties===!0||n==null&&this.validatorOptions&&this.validatorOptions.skipMissingProperties===!0||(this.customValidations(t,n,f,c),this.nestedValidations(n,l,c),this.mapContexts(t,n,r,c),this.mapContexts(t,n,f,c))))},e.prototype.generateValidationError=function(t,n,i){var o=new C;return(!this.validatorOptions||!this.validatorOptions.validationError||this.validatorOptions.validationError.target===void 0||this.validatorOptions.validationError.target===!0)&&(o.target=t),(!this.validatorOptions||!this.validatorOptions.validationError||this.validatorOptions.validationError.value===void 0||this.validatorOptions.validationError.value===!0)&&(o.value=n),o.property=i,o.children=[],o.constraints={},o},e.prototype.conditionalValidations=function(t,n,i){return i.map(function(o){return o.constraints[0](t,n)}).reduce(function(o,r){return o&&r},!0)},e.prototype.customValidations=function(t,n,i,o){var r=this;i.forEach(function(a){r.metadataStorage.getTargetValidatorConstraints(a.constraintCls).forEach(function(f){if(!(f.async&&r.ignoreAsyncValidations)&&!(r.validatorOptions&&r.validatorOptions.stopAtFirstError&&Object.keys(o.constraints||{}).length>0)){var l={targetName:t.constructor?t.constructor.name:void 0,property:a.propertyName,object:t,value:n,constraints:a.constraints};if(!a.each||!(Array.isArray(n)||n instanceof Set||n instanceof Map)){var s=f.instance.validate(n,l);if(j(s)){var c=s.then(function(h){if(!h){var L=I(r.createValidationError(t,n,a,f),2),M=L[0],N=L[1];o.constraints[M]=N,a.context&&(o.contexts||(o.contexts={}),o.contexts[M]=Object.assign(o.contexts[M]||{},a.context))}});r.awaitingPromises.push(c)}else if(!s){var p=I(r.createValidationError(t,n,a,f),2),d=p[0],g=p[1];o.constraints[d]=g}return}var O=q(n),V=O.map(function(h){return f.instance.validate(h,l)}),A=V.some(function(h){return j(h)});if(A){var b=V.map(function(h){return j(h)?h:Promise.resolve(h)}),E=Promise.all(b).then(function(h){var L=h.every(function(at){return at});if(!L){var M=I(r.createValidationError(t,n,a,f),2),N=M[0],ot=M[1];o.constraints[N]=ot,a.context&&(o.contexts||(o.contexts={}),o.contexts[N]=Object.assign(o.contexts[N]||{},a.context))}});r.awaitingPromises.push(E);return}var U=V.every(function(h){return h});if(!U){var u=I(r.createValidationError(t,n,a,f),2),d=u[0],g=u[1];o.constraints[d]=g}}})})},e.prototype.nestedValidations=function(t,n,i){var o=this;t!==void 0&&n.forEach(function(r){if(!(r.type!==w.NESTED_VALIDATION&&r.type!==w.PROMISE_VALIDATION)&&!(o.validatorOptions&&o.validatorOptions.stopAtFirstError&&Object.keys(i.constraints||{}).length>0))if(Array.isArray(t)||t instanceof Set||t instanceof Map){var a=t instanceof Set?Array.from(t):t;a.forEach(function(p,d){o.performValidations(t,p,d.toString(),[],n,i.children)})}else if(t instanceof Object){var f=typeof r.target=="string"?r.target:r.target.name;o.execute(t,f,i.children)}else{var l=I(o.createValidationError(r.target,t,r),2),s=l[0],c=l[1];i.constraints[s]=c}})},e.prototype.mapContexts=function(t,n,i,o){var r=this;return i.forEach(function(a){if(a.context){var f=void 0;if(a.type===w.CUSTOM_VALIDATION){var l=r.metadataStorage.getTargetValidatorConstraints(a.constraintCls);f=l[0]}var s=r.getConstraintType(a,f);o.constraints[s]&&(o.contexts||(o.contexts={}),o.contexts[s]=Object.assign(o.contexts[s]||{},a.context))}})},e.prototype.createValidationError=function(t,n,i,o){var r=t.constructor?t.constructor.name:void 0,a=this.getConstraintType(i,o),f={targetName:r,property:i.propertyName,object:t,value:n,constraints:i.constraints},l=i.message||"";!i.message&&(!this.validatorOptions||this.validatorOptions&&!this.validatorOptions.dismissDefaultMessages)&&o&&o.instance.defaultMessage instanceof Function&&(l=o.instance.defaultMessage(f));var s=Z.replaceMessageSpecialTokens(l,f);return[a,s]},e.prototype.getConstraintType=function(t,n){var i=n&&n.name?n.name:t.type;return i},e}(),tt=function(e,t,n,i){function o(r){return r instanceof n?r:new n(function(a){a(r)})}return new(n||(n=Promise))(function(r,a){function f(c){try{s(i.next(c))}catch(p){a(p)}}function l(c){try{s(i.throw(c))}catch(p){a(p)}}function s(c){c.done?r(c.value):o(c.value).then(f,l)}s((i=i.apply(e,t||[])).next())})},nt=function(e,t){var n={label:0,sent:function(){if(r[0]&1)throw r[1];return r[1]},trys:[],ops:[]},i,o,r,a;return a={next:f(0),throw:f(1),return:f(2)},typeof Symbol=="function"&&(a[Symbol.iterator]=function(){return this}),a;function f(s){return function(c){return l([s,c])}}function l(s){if(i)throw new TypeError("Generator is already executing.");for(;a&&(a=0,s[0]&&(n=0)),n;)try{if(i=1,o&&(r=s[0]&2?o.return:s[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,s[1])).done)return r;switch(o=0,r&&(s=[s[0]&2,r.value]),s[0]){case 0:case 1:r=s;break;case 4:return n.label++,{value:s[1],done:!1};case 5:n.label++,o=s[1],s=[0];continue;case 7:s=n.ops.pop(),n.trys.pop();continue;default:if(r=n.trys,!(r=r.length>0&&r[r.length-1])&&(s[0]===6||s[0]===2)){n=0;continue}if(s[0]===3&&(!r||s[1]>r[0]&&s[1]<r[3])){n.label=s[1];break}if(s[0]===6&&n.label<r[1]){n.label=r[1],r=s;break}if(r&&n.label<r[2]){n.label=r[2],n.ops.push(s);break}r[2]&&n.ops.pop(),n.trys.pop();continue}s=t.call(e,n)}catch(c){s=[6,c],o=0}finally{i=r=0}if(s[0]&5)throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}},G=function(){function e(){}return e.prototype.validate=function(t,n,i){return this.coreValidate(t,n,i)},e.prototype.validateOrReject=function(t,n,i){return tt(this,void 0,void 0,function(){var o;return nt(this,function(r){switch(r.label){case 0:return[4,this.coreValidate(t,n,i)];case 1:return o=r.sent(),o.length?[2,Promise.reject(o)]:[2]}})})},e.prototype.validateSync=function(t,n,i){var o=typeof t=="string"?n:t,r=typeof t=="string"?i:n,a=typeof t=="string"?t:void 0,f=new B(this,r);f.ignoreAsyncValidations=!0;var l=[];return f.execute(o,a,l),f.stripEmptyErrors(l)},e.prototype.coreValidate=function(t,n,i){var o=typeof t=="string"?n:t,r=typeof t=="string"?i:n,a=typeof t=="string"?t:void 0,f=new B(this,r),l=[];return f.execute(o,a,l),Promise.all(f.awaitingPromises).then(function(){return f.stripEmptyErrors(l)})},e}(),it=new(function(){function e(){this.instances=[]}return e.prototype.get=function(t){var n=this.instances.find(function(i){return i.type===t});return n||(n={type:t,object:new t},this.instances.push(n)),n.object},e}());function W(e){return it.get(e)}function et(e,t,n){return typeof e=="string"?W(G).validateSync(e,t,n):W(G).validateSync(e,t)}const rt=e=>{let t,n=!1;const i=e.propertyName;if(e.name==="isInstance")t=e.constraints[0];else if(e.name==="isInterface")t=e.constraints[0];else if(e.name==="isString")t=String,n=!0;else if(e.name==="isBoolean")t=Boolean,n=!0;else if(e.name==="isObject")t=Object,n=!0;else if(e.name==="isEnum")t=e.constraints[0],n=!0;else throw new Error(`Not Implemented ${e.name} type map for property ${i}`);return[i,{propType:t,isPrimitive:n}]},z=e=>Object.fromEntries(e.filter(t=>t.each===!0).map(rt)),H=e=>Object.fromEntries(e.filter(t=>t.name==="isEnum").map(t=>[t.propertyName,t.constraints[0]])),P=class P{constructor(t){D(this,x,R().getTargetValidationMetadatas(this.constructor,"",!1,!1,[]));D(this,k,z(S(this,x)));D(this,_,H(S(this,x)));D(this,m,new Set(S(this,x).map(t=>t.propertyName)));if(t===void 0){Object.freeze();return}for(const n of S(this,m)){const i=t[n];i!=null&&(this[n]=this.fromPlain(n,i)),Object.freeze(this[n])}Object.freeze(this),this.validate()}toPlain(){const t={};for(const n of S(this,m))this[n]!==void 0&&this[n]!==null&&(t[n]=this.fieldToPlain(this[n],n));return t}fromPlain(t,n){const i=Reflect.getMetadata("design:type",this,t);if(i.prototype instanceof P&&!(n instanceof i))return new i(n);if(i===Date)return new i(n);if(i===Array){const{propType:o,isPrimitive:r}=S(this,k)[t];return n.map(a=>r||a instanceof o?a:new o(a))}else return this.isEnum(t)?this.toEnumString(n,t):n}fieldToPlain(t,n){return t instanceof P?t.toPlain():this.isArray(t)?t.map(i=>this.fieldToPlain(i,n)):this.isEnum(n)?this.toEnumString(t,n):t}validate(){const t=et(this,{whitelist:!0,forbidNonWhitelisted:!0});if(t.length>0)throw t}isEnum(t){return t in S(this,_)}toEnumString(t,n){if(this.isString(t))return t;if(Number.isInteger(t))return S(this,_)[n][t];if(this.isObject(t))return t.toString();throw new C(`Unexpected type ${t} found in enum ${n}`)}isString(t){return Object.prototype.toString.call(t)==="[object String]"}isObject(t){return Object.prototype.toString.call(t)==="[object Object]"}isArray(t){return Object.prototype.toString.call(t)==="[object Array]"}};x=new WeakMap,k=new WeakMap,_=new WeakMap,m=new WeakMap;let F=P;y.default=F,y.reflectArrayClasses=z,y.reflectEnums=H,Object.defineProperties(y,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
